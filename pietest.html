<div id="pie"></div>
<script src="d3/d3.js"></script>
<script>
var data = [{key: "rest", value: 70}, {key: 'target', value: 30}];
</script>
<script>
/**
 * converts a data array into an array
 * of pie data with computed startAngle, endAngle
 * and other properties used to create arcs
 * @param {array} data
 * @return {array}
 */
 var getPieData = d3.pie()
    .sort(function (a, b) { return b.value - a.value})
    .value(function (d) { return d.value });

/**
 * generates an svg transform to translate and scale
 * a group to match a standard cartesian coordinate space
 * i.e. the origin is at the center, x increases going right
 * and y increases going down
 * @param {number} width
 * @param {number} height
 * @return {string} svg transform string
 */
function getStandardCartesianTransform (width, height) {
    return 'translate(' + (width/2) + ',' + (height/2) + ')'
    + ' scale(1,-1)';
}

/**
 * generates an svg transform to rotate a pie/circle
 * by the specified angle (in degrees) from the
 * x-axis (after a 90degree rotation)
 * @param {number} angle
 * @return {string} svg transform string
 */
function getPieRotationTransform (angle) {
    return ' rotate(' + (90 + angle) + ')';
}

/**
 * compute the angle by which the pie has to be rotated relative
 * to the x-axis so that the x-axis cuts through the middle of
 * the target (open) sector
 * @param {array} pieData
 * @return {number} the angle for rotation
 */
function getPieRotationAngle (pieData) {
    var target = pieData.find(function (d) { return d.data.key === 'target'; });
    var total = d3.sum(pieData, function (d) { return d.value; });
    return 180 * target.value / total;
}

/**
 * returns a function with generates coordinates
 * for dots that are constrained within the open sector
 * of the pie
 * @param {number} radius the radius of the pie
 * @param {number} startAngle the start angle of the open sector in radians
 * @param {number} endAngle the end angle of the open sector in radians
 * @return {function} a function that, when called, returns an object
 * {x, y} where x and y are coordinates for a random point within the
 * specified open sector
 */
function sectorCoordGenerator (radius, startAngle, endAngle) {
    var angle = (endAngle  - startAngle) / 2;
    var maxY = radius * Math.sin(angle);
    var minY = -maxY;
    var getRandomY = d3.randomUniform(minY, maxY);
    var getRandomXForY = function (y) {
        var minX = Math.abs(y)/Math.tan(angle);
        var maxX = Math.sqrt(radius*radius - y*y);
        return d3.randomUniform(minX, maxX)();
    }
    return function () {
        var y = getRandomY();
        var x = getRandomXForY(y);
        return {
            x: x,
            y: y
        };
    };
}

/**
 * generate dots representing the target data
 * to be displayed inside the open sector of the
 * pie
 * @param {array} pieData
 * @return {array}
 */
function generateSectorDots (pieData, radius) {
    var target = pieData.find(function (d) { return d.data.key === 'target'});
    var getRandomCoords = sectorCoordGenerator(radius, target.startAngle, target.endAngle);
    var dots = d3.range(target.value).map(function (d, i) {
       var dot = getRandomCoords();
       dot.key = i;
       return dot;
    });
    return dots;
}
</script>
<script>
var width = 700;
var height = 300;
var mainRadius = Math.min(width, height) / 2;
</script>
<script>
var root = d3.select("#pie");
var svg = root.append('svg')
    .attr('width', width)
    .attr('height', height);

/**
 * top-level group, wraps children in a cartesian coord space
 * with the origin at the center, x increasing going right
 * and y increasing going up
 */
var g = svg.append('g')
    .attr('transform', getStandardCartesianTransform(width, height));

/**
 * group containing the pie chart
 * pie chart will be in its own group so that
 * its rotation does not affect the rest of the children
 */
var pieG = g.append('g');

/**
 * function used to generate arc paths for the
 * sectors
 */
var pathFn = d3.arc()
    .outerRadius(mainRadius)
    .innerRadius(0);
</script>
<script>
/**
 * renders the pie chart with the specified pie data
 * @param {array} pieData data that has been passed
 * through getPieData function
 */
function renderPie (pieData) {
    var angle = getPieRotationAngle(pieData);
    pieG.transition()
        .attr('transform', getPieRotationTransform(angle));

    var arc = pieG.selectAll('.arc')
        .data(pieData, function (d) { return d.data.key; });
    arc.exit().remove();
    var newArc = arc.enter().append('path')
        .attr('class', 'arc');
    
    arc = arc.merge(newArc);
    arc.transition()
        .attr('d', pathFn)
        .attr('fill', function(d) {
            return d.data.key === 'rest'? 'red': 'white';
        });
}

/**
 * render dots representing the target population
 * in the open sector of the pie chart
 * @param {array} pieData data that has been passed
 * through getPieData function
 */
function renderDots (pieData) {
    var dots = generateSectorDots(pieData, mainRadius);
    var circles = g.selectAll('.dot').data(dots, function (dot) { return dot.key; });
    circles.exit().remove();
    var newCircles = circles.enter().append('circle')
        .attr('class', 'dot');

    circles = circles.merge(newCircles);
    circles
        .transition()
        .attr('cx', function (d) {
            return d.x;
        })
        .attr('cy', function (d) {
            return d.y;
        })
        .attr('r', 2);
}

function renderPieAndDots (data) {
    var pieData = getPieData(data);
    renderPie(pieData);
    renderDots(pieData);
}
</script>
<script>
renderPieAndDots(data);
</script>