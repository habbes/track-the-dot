<div id="pie"></div>
<script src="d3/d3.js"></script>
<script>
var illiteracyData = {
    'Naivasha': {
        town: 'Naivasha',
        child: 10,
        youth: 35,
        man: 30,
        woman: 25
    },
    'Molo': {
        town: 'Molo',
        child: 10,
        youth: 40,
        man: 20,
        woman: 30
    }
};

/**
    * generates an random array of individual data points based on the
    * the percentage counts of the different categories
    * in the specified town data
    * @param {object} data
    * @return {array}
    */
function generateDatapointsForTown (data) {
    var categories = ['child', 'youth', 'man', 'woman'];
    var datapoints = categories.reduce(function(points, cat) {
        var categoryPoints = generateDatapointsForCategory(data, cat);
        return d3.merge([points, categoryPoints]);
    }, []);
    return d3.shuffle(datapoints);
}

/**
    * generates an array of individual data points for
    * a given category based on its proportion in the
    * counts of a particular town
    * @param {object} data town data
    * @param {string} category
    * @return {array}
    */
function generateDatapointsForCategory (data, category) {
    var count = data[category];
    return d3.range(count).map(function (i) {
        return {
            category: category,
            key: category + '_' +  i,
            size: count,
            cx: Math.random(),
            cy: Math.random()
        }
    });
}

</script>
<script>
var width = 700;
var height = 300;
var mainRadius = Math.min(width, height) / 2;
</script>
<script>
var root = d3.select("#pie");
var svg = root.append('svg')
    .attr('width', width)
    .attr('height', height);

var g = svg.append('g');
var pieG = g.append('g')
    .attr('class', 'pieG');

g.append('line')
    .attr('x1', 0)
    .attr('y1', 0)
    .attr('x2', 40)
    .attr('y2', 0)
    .attr('style', 'stroke:black;stroke-width:2');

g.append('line')
    .attr('x1', 0)
    .attr('y1', 0)
    .attr('x2', 0)
    .attr('y2', 40)
    .attr('style', 'stroke:black;stroke-width:2');

function getTransform (width, height, rotate) {
    rotate = rotate || 0;
    return 'translate(' + (width/2) + ',' + (height/2) + ')'
    + ' scale(1,-1)'
        // + ' rotate(90)'
        // + ' rotate(' + rotate + ')'
      
}

function rotateTransform (rotate) {
    return ' rotate(' + (90 + rotate) + ')';
}

function getRotation (pieData) {
    var target = pieData.find(e => e.data.key === 'target');
    var total = d3.sum(pieData, d => d.value);
    return 180 * target.value / total;
}

var data = [{key: "rest", value: 90}, {key: 'target', value: 10}];
var pie = d3.pie()
    .sort(function (a, b) { return b.value - a.value})
    .value(function (d) { return d.value });

var pathFn = d3.arc()
    .outerRadius(mainRadius)
    .innerRadius(0);


// pieData = pie(data);
// var arc = g.selectAll('.arc')
//     .data(pieData)
//     .enter().append('g')
//         .attr('class', 'arc');
// function getRotation (pieData) {
//     var target = pieData.find(e => e.data.key == 'target');
//     var total = d3.sum(pieData, d => d.value);
//     var angle = (target.endAngle = target.startAngle) / 2;
//     // return angle + 'rad';
//     return 180 * target.value/total;
// }
// var rotation = getRotation(pieData);
// var transform = getTransform(width, height, rotation);
// console.log(transform);

// g.transition().duration(1000).attr('transform', transform);
// arc.append('path')
//     .attr('d', path)
//     .attr('fill', function (d) { 
//         return d.data.key === 'rest'? 'red' : 'white';
//     });
</script>
<script>
function renderPie (data) {
    pieData = pie(data);

    var rotation = getRotation(pieData);
    var transform = getTransform(width, height, rotation);
    console.log('t', transform);
    g.transition()
        .attr('transform', transform);
    pieG.transition()
        .attr('transform', rotateTransform(rotation));
    console.log(pieG);
    var arc = pieG.selectAll('.arc')
        .data(pieData, function (d) { return d.data.key; });
    arc.exit().remove();
    var newArc = arc.enter().append('g')
        .attr('class', 'arc');
    
    arc = arc.merge(newArc);
    arc.append('path')
        .attr('d', pathFn)
        .attr('fill', function(d) {
            return d.data.key === 'rest'? 'red': 'white';
        });
}

renderPie(data);
</script>
<script>

function sectorCoordGenerator (radius, startAngle, endAngle) {
    var angle = (endAngle  - startAngle) / 2;
    var maxY = radius * Math.sin(angle);
    var minY = 0;
    console.log('y range', minY, maxY);
    var getRandomY = d3.randomUniform(minY, maxY);
    var getRandomX = function (y) {
        var minX = y/Math.tan(angle);
        var maxX = Math.sqrt(radius*radius - y*y);
        return d3.randomUniform(minX, maxX)();
    }
    return function () {
        var y = getRandomY();
        var x = getRandomX(y);
        return {
            x: x,
            y: y
        };
    };
}

function generateSectorDots (data) {
    pieData = pie(data);
    var target = pieData.find(e => e.data.key === 'target');
    var getRandomCoords = sectorCoordGenerator(mainRadius, target.startAngle, target.endAngle);
    var dots = d3.range(target.value).map(function (d, i) {
       var dot = getRandomCoords();
       dot.key = i;
       return dot;
    });
    return dots;
}

</script>
<script>
function renderDots (data) {
    var dots = generateSectorDots(data);
    var circles = g.selectAll('.dot').data(dots, function (dot) { return dot.key; });
    circles.exit().remove();
    var newCircles = circles.enter().append('circle')
        .attr('class', 'dot');

    circles = circles.merge(newCircles);
    circles
        .attr('cx', function (data) {
            return data.x;
        })
        .attr('cy', function (data) {
            return data.y;
        })
        .attr('r', 2);
    

}
renderDots(data);
</script>